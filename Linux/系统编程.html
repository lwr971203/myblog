<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>系统编程 | 不刻意的个人博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="个人博客，用于记录所学到的知识">
    
    <link rel="preload" href="/myblog/assets/css/0.styles.f30d1b65.css" as="style"><link rel="preload" href="/myblog/assets/js/app.cf03cf17.js" as="script"><link rel="preload" href="/myblog/assets/js/7.c0fa18da.js" as="script"><link rel="preload" href="/myblog/assets/js/2.5b1d6a19.js" as="script"><link rel="preload" href="/myblog/assets/js/1.3eb0cb5d.js" as="script"><link rel="preload" href="/myblog/assets/js/31.790d8053.js" as="script"><link rel="prefetch" href="/myblog/assets/js/10.c864b33b.js"><link rel="prefetch" href="/myblog/assets/js/11.d639a8b7.js"><link rel="prefetch" href="/myblog/assets/js/14.d7d8b557.js"><link rel="prefetch" href="/myblog/assets/js/15.400fffef.js"><link rel="prefetch" href="/myblog/assets/js/16.3a98beb2.js"><link rel="prefetch" href="/myblog/assets/js/17.26e9f21d.js"><link rel="prefetch" href="/myblog/assets/js/18.b01b3a63.js"><link rel="prefetch" href="/myblog/assets/js/19.9746740f.js"><link rel="prefetch" href="/myblog/assets/js/20.1faabea6.js"><link rel="prefetch" href="/myblog/assets/js/21.4913a81b.js"><link rel="prefetch" href="/myblog/assets/js/22.ec2bffa8.js"><link rel="prefetch" href="/myblog/assets/js/23.77700c61.js"><link rel="prefetch" href="/myblog/assets/js/24.6badfe0e.js"><link rel="prefetch" href="/myblog/assets/js/25.bda1b3e1.js"><link rel="prefetch" href="/myblog/assets/js/26.06377f0d.js"><link rel="prefetch" href="/myblog/assets/js/27.86112ea9.js"><link rel="prefetch" href="/myblog/assets/js/28.be8ca15b.js"><link rel="prefetch" href="/myblog/assets/js/29.98f0eb72.js"><link rel="prefetch" href="/myblog/assets/js/3.6742e681.js"><link rel="prefetch" href="/myblog/assets/js/30.4c7947d3.js"><link rel="prefetch" href="/myblog/assets/js/32.a5e964d1.js"><link rel="prefetch" href="/myblog/assets/js/33.b8ed26ef.js"><link rel="prefetch" href="/myblog/assets/js/34.df1871ba.js"><link rel="prefetch" href="/myblog/assets/js/35.bb3bd585.js"><link rel="prefetch" href="/myblog/assets/js/36.3db4a564.js"><link rel="prefetch" href="/myblog/assets/js/37.6be88695.js"><link rel="prefetch" href="/myblog/assets/js/38.98231313.js"><link rel="prefetch" href="/myblog/assets/js/39.35b7389e.js"><link rel="prefetch" href="/myblog/assets/js/4.a44ee4eb.js"><link rel="prefetch" href="/myblog/assets/js/40.1b255cff.js"><link rel="prefetch" href="/myblog/assets/js/41.14266a67.js"><link rel="prefetch" href="/myblog/assets/js/42.158b316e.js"><link rel="prefetch" href="/myblog/assets/js/5.a49af4e2.js"><link rel="prefetch" href="/myblog/assets/js/6.be903aa2.js"><link rel="prefetch" href="/myblog/assets/js/8.50764dc8.js"><link rel="prefetch" href="/myblog/assets/js/9.57b2eeab.js"><link rel="prefetch" href="/myblog/assets/js/vendors~docsearch.fea53d47.js">
    <link rel="stylesheet" href="/myblog/assets/css/0.styles.f30d1b65.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>不刻意的个人博客</h3> <p class="description" data-v-59e6cb88>个人博客，用于记录所学到的知识</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myblog/" class="home-link router-link-active"><!----> <span class="site-name">不刻意的个人博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      后端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/Linux/基础.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      探索
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lwr971203" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.yuque.com/lwr971203" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  语雀
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/myblog/about_me.html" class="nav-link"><i class="undefined"></i>
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>4</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      后端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/myblog/Linux/基础.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      探索
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lwr971203" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.yuque.com/lwr971203" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  语雀
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/myblog/about_me.html" class="nav-link"><i class="undefined"></i>
  关于我
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/myblog/Linux/基础" class="sidebar-heading clickable open"><span>Linux</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/myblog/Linux/基础.html" class="sidebar-link">基础</a></li><li><a href="/myblog/Linux/shell编程.html" class="sidebar-link">shell编程</a></li><li><a href="/myblog/Linux/系统编程.html" class="active sidebar-link">系统编程</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>系统编程</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">系统编程</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>不刻意</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2018/8/2</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="基础知识"><a href="#基础知识" class="header-anchor">#</a> 基础知识</h2> <h3 id="虚拟地址空间"><a href="#虚拟地址空间" class="header-anchor">#</a> 虚拟地址空间</h3> <p>以32位机器为例，每个进程都会运行在 4G 的<strong>虚拟</strong>地址空间，<strong>从低地址向高地址</strong>大致分为如下区域</p> <ul><li>用户空间（0 - 3G）：
<ul><li>保留空间：在虚拟地址空间的最底部，无法使用，比如空指针（NULL）指向就在这个内存区域</li> <li>.text 段：俗称代码段，存储要执行的机器指令</li> <li>.rodata 段：存储<strong>静态存储期</strong>的常量数据</li> <li>.data 段：存储<strong>静态存储期</strong>的已初始化为非零的数据</li> <li>.bss 段：存储<strong>静态存储期</strong>的未初始化或初始化为零的数据</li> <li>heap 区：存储<strong>动态存储期</strong>（ c 中叫<strong>分配存储期</strong>）的数据，非连续内存空间</li> <li>mmap 区：加载磁盘文件、加载共享库</li> <li>stack 区：存储<strong>自动存储期</strong>的数据，是连续内存空间</li> <li>命令行参数</li> <li>环境变量</li></ul></li> <li>内核空间（3G - 4G）：略，重点知道 <strong>PCB</strong> 即可</li></ul> <blockquote><p>在最终的可执行程序中，.text 段和.rodata 段会被合并，.data 段和.bss 段会被合并</p> <p>虚拟地址空间并不是进程所实际占用的物理内存，里面的地址也不是实际的物理地址，虽然它是 c 指针所记录的地址；</p> <p>一切虚拟地址空间的地址最终都会由 <strong>MMU</strong> 负责映射到实际的物理地址（依赖 PCB 中的虚拟地址空间映射表）</p></blockquote> <h3 id="mmu"><a href="#mmu" class="header-anchor">#</a> MMU</h3> <p>是 cpu 中的一个模块，负责将进程的虚拟地址空间映射到实际的物理内存空间中，并且通过设置访问级别来将虚拟地址空间分为内核空间和用户空间</p> <h3 id="pcb"><a href="#pcb" class="header-anchor">#</a> PCB</h3> <p>在每个进程的内核空间中，都会产生一个结构体<code>task_struct</code>，源码：<code>/usr/src/linux-headers-5.4.0-150-generic/include/linux/sched.h</code></p> <p><img src="/myblog/assets/img/image-20240506150113965.3007dcb7.png" alt="image-20240506150113965"></p> <p>需要重点掌握的成员：</p> <ul><li>进程状态</li> <li>进程切换时需要保存和恢复的一些cpu寄存器信息</li> <li>虚拟地址空间映射表</li> <li>打开的文件信息（里面有文件描述符表）</li> <li>会话和进程组</li> <li>当前控制终端信息</li> <li>当前工作目录</li> <li>用户 id 和组 id</li> <li>umask掩码</li> <li>可以使用的资源上限（ulimit）</li> <li>信号相关的信息：未决信号集、信号屏蔽字</li></ul> <blockquote><p>PCB 全称是<strong>进程控制块</strong>，有些资料也喜欢说成<strong>进程描述符</strong></p></blockquote> <h3 id="文件描述符"><a href="#文件描述符" class="header-anchor">#</a> 文件描述符</h3> <p>进程每打开一个文件，都会创建一个用来描述这个文件的结构体，并给出指代这个结构体的<strong>非负整数</strong>，这个整数就是文件描述符</p> <ol><li><p>PCB 中的成员<code>files</code>：它有一个数组成员就是文件描述符表</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApoAAABCCAIAAAB4nOHDAAAaF0lEQVR4nO2df1BUV5bHv6NBbTCjdmhs7UY6AgmFKFCmEBmTUMA602qZqJWmVqeiuOA6rDNglShlXH+kogXBKiFxWVdYwdTqFlroaBl61kXKJA4aKpS/iGUCGpBGW2GIzsoPf5DaP97r7verm/7dPDif4g/e7dv3nffe7XvuOffc836l1WpBEARBEIScGRdoAQiCIAiC8BRS5wRBEAQhe0idEwRBEITsIXVOEARBELKH1DlBEARByB5S5wRBEAQhe0idEwRBEITsIXVOEARBELLnlUALMHoJz0zcold0G69/UtNn59OBY+tuN/lfshGNKqc6Oo5z3FLZWHGJV4O5scDAhd1Xz7aLGlgUU5at5BaIW/AlIcuL4tPVgLlrf2FHp5caTcpPWZPAOb7Wmlfa7aW2RxK6iB27NSrA3q9GLiTlp6xRu9IBmAv3ap8hxh5knfuKkMREBTBw41v7o5J54IEfBZIBi2LK+LpcCubGAlDMWxDie5lcRBc6Tw0AUCsTdV5pUZVTzdflsmNRTFl1yo7M4R9W+AKlCgCgSgwN97VUvsbc77xiZi68+2oP6XLCAwTW+cv1BeaVodbDkNJt0+rtfDNqyaPSd58DwK3QZUcn2T3D/J/PGfoAoGdqfsnkNg/llQ3MsH7NxDcfVTnV2oe7r55tR2fXABKZwpDlRfHTz7lvQQpMN/8ao15ElcNY1cOYnn1Xrw6k6+1PlS7dzmMv32Io+5P2nhtmTboaMPdeFXsOXCcpn5nf9MrXkZP0lnL4SgCAzm97u/UauSo2XcSO3Yrz6243AQ8eDGAGU2r7yduHmaH2npezQ4IYAXDUuVXv2ujLL+5LOaH9uJlbKFD5dslYa8qP9YaMciTpfY0KaPmOr5YWvRYHRdzulPRrrXnfAeb+Tqtn+C0VLrnuPrU4J7nEZaeUvSVDZ6wueDoAc9f+4STvrLmaV+MXkdyh72xh41mvtRaiVgMYuLBbrrrcNdo7PlnXEWgh3CR8gVIFxZrqlMXG60eB7gf9llUhTF8QcrbdvqpeFJ6uBq79bUw8YsKHWNX54E5DH4D7X6k31LGFjP2dZPg5o9lqow/uLO5JAgA0ndA2xtlT2DaVf/8r9afoZe34MYMqPgEwd/1FYCWzhqMqpzq6LAGAsizBE2NalcPoco45y44gCdE7MvtltvqoVaiGrzTWCJ7uZ+8C4S7sLFMXsWN3/BYAiN+CgQu7Gx3a5QDrvRi48Ge5zb+JEYdVc/89CcCtUKsuB9BWF1aqMuXH9qXMn1bPGuiTjn81QQslUy3D7jLnK0caQlbGKRgnfNQS38k/IgnP1MY5chj2PzQjjh2mBx6aPDqLwDXdWXM1ryumLFup0ocn1TAmnSqnOjqOibLhWfN2/Lf8UDLxbCMpP2VNAhOGxg1bsxOY5j2sto4Fb5yR797wIAJL5NiXDmviPAvuffYwBkoQ/SexWsE5L09UTh9gbsW11rw/B+/gTBOtt13UE4RBi/y7J/xUpY8v03OOuUKKnEyOHoSgsvjWLYopy1YyLXDXoRy0yVTzTvxde/9DwCLegHnY/qmLWJzgtaUZYmzDKm+d6jmAphbhEnh9S0h+bF9S3CCa2Y/a6sI2ONNw87RlzcPXGpXYD4KzDrvmrv2Vii3LBvafU2zZnZION2KVVb9jorvFk/pLnReWKdPVyvhFaLKOv2pFolAdKtdUx4Cv0YUR1HZd94rp78eUJXDXRBXpuxPhsn4VDvpQa7ZUa2yHvoz1Fc0PoNLHlyX6PrpYrfhdfkoc9z6rNVuKYD2v6Cko0plOwsKdx0jFByREl1VrJeY6asUMXcRanuIU94Hg5RstFRK0yzNfS7fcorjsmKRLlpqi7QPwy90T90+mw4gnnaoZ4TnVSsF8YgekFDajUAGV/o3l37o/QbR1p2ut+x9ot8ww7X+g3VKdssbhTIKC4AjvwQuF005/KQyOMwfdB2aGvYwCxkwUm4ewK2EmiXHh0t9ashVMXEx4ZiIwgEu38y6FLC+Kn/6di642ZqVZevrfZzYDakzXhADWQUSZrgfHGmP0qHJxZkiTdaBZFLMmATxtwVhCCdE5i7oFw2VcghI2i41RKor091VnfbZmz1kyF00C3EAXsVZodKpyqqPj1Jq1mT2uW2mcJXMpVcdHGZcA27NgbrJa87tFHa4uu4RnvpHOLq5b9RBzcxTpGyOuCjWrcs1uwHbJUn0gQZOO3mPrbiM/ZU2CIl2vwLXWvFIwbap1gK2/8b07zFXbrqK7Yh3bE4a3fTlL5hIKm3MK5iPOI2NnM7ypBnshSq7vitG1HJeV9+n8trdbz4bCJeVHg+2xqpxq7UO721uYSTkFwRFegVXejBU+813zzoecwDfN08N/ejwzUKLJFCaOVxgEx2Ib4zj0nS1sdPk0zEqzna1uDx4MIEEhLOVZut0Vla+VZStViaHhNX2dABCyfJlS6MFu7/hkN3bs1sQtiwi/JNAN3Jp9Z8/1pmcroQ4OB1yxMzg3hNEH/tp6y8Yq8qy67op1yKmOjvPloM/Cvcz2jvPXNGsSbNOvptJGy9kZjWtvWcHioeF9arkKtTJR19Ep/Ba3cvdfjNo4vUI1I5gz7UO3sbMJCGe7EOP+CeEsDwHgbh+wlRx7K4V7Fd6G6Z+CR9Z3tvA6iuKFvij2QmwTiM4aU4tePCMBYLv/3cYfPVq7ae/4ZJ24VPInb2HRa3GgIDjCW1j2nTe/eqoHAJIMpnPFlj/S5a5jJwhOErVihodnc2Fv68CFQ3w1eelvLVwZmJ114jW89v6HUqIKxz7TgKwieVTxCQB6rwsfU/9DM8AM+j5E+CwePBhwpxlGGUgsu3ZfvwapffnCaUFnl/i8fEtR0skUENgN/eJH1nf16gCAuLf4kZTmrqM8k5d5stI0lTbmrWv0cuioOnjYrfMUBEd4Fatr/ZUjJdqvrVvJGXqm5je8KDX04dEr5Gl3iuGC4Gx4Z7eVy9awGIu9wpj7gqXr0Qq7VKFcU52yJtCyuE24RgFIT+mk3TNixEY2n+4H/fY/9MaSh/PYd0d1dg0ATlysH+H4V+xDQXCEl+GtlLfVhS2r438+/2cA97spF6xT+DEdhGmg2xZAK2TGDAWAh13OiOFE8C1B8BFHERKuwgTBtZyjrK6Et3Csp1+uT+sDYHpI6twZ/JkOgtkPI70+yniSh9sCx1qoFpj5wRjJGs3uJpJxqjVYrVIpD40r8zk3YNbshdsxHEWxeQ7TP9WKGaKLZbwUDh0JIxA2CE60dkAQbuMoZ3vUkt6VoUDP1ONjdcuZazgMgvM67Ppo+vtCE53djz6cE4/Nj22dfLBr5N7KND7CYVZSlfGLAi2IJzDxCuJHxu68cj+lwTAwa/boPebPzINM/5R4ZOzcwpO5S1J+ipNZ5b0GBcER3seeOh/cWWwqffc5MOHU8bGTaN0jXAmC8wZNf+7qBpAQXZZv0+i2pB8OnXi2l5LZwnC6/2IcYLaPL+erh6R8/450/qDv7LleAHHZKTl89RCemci9nyOa9o7zzJSO98isuQJ9FsXGhj1yNauj98QwgX4q/RvLPZopMv1T8MhClhdFx8Gz3x1337m/5rIUBEf4AJsXXSrF+oRTn4Ud6eIVSVSL7TlXzPxne2VLlCCqDkDo49Lix/aalT3OB8F5jfaOo0Ylk9K1rDqa+0m38bpoB7MgFQkAtFTy45xrfryQGJ+ulqjZHfhXv4nzpXDk5Hh9pTPhZAPgbw+zbKyyfWrlmuvSiZPnc4IKffdSnKbS1nhml7ngkTmR+t59LK+Zkbh1Ulg3ifGEFGcm5sBJIWdbELH0T/F5e4/Ja4WIguAIn2DPOp9w6jPtsm2jTun6jMC8E6mz5mreutYWXlnvMWe23Ji79q8T65i+s4WNeZW9gtKWSm/v4RkZNJU25u3uEii9buN1Wb29prtiXeMx/vyjpbIxz7fqre9s4fULvH1fvcfWSfQcC90V6wT13T5v434jb3Ndt/F6nocBEKyTw+N9505DQXCEb/iVVqsNtAyjACYFisuJWv2D41QkBEH4E+b3KO8wTGJE4igUjnAW/wbBEQQhWygIjvAVpM49h10J818QHEEQ8sSSSpmC4AjvQxvKPYfzAgmCIAj7cF7VQxBehqxzgiAIgpA9FApHEARBELKHrHOCIAiCkD2kzgmCIAhC9lAoHOFboqOjh680YmhtbQ20CMQIhXoyMcIhdU74kOjoaLVaPXy9kQSNg4QY6snEyIfUOeErmBHQbPZCdk+/wQzZNA4SXKgnE7Jg/K9//etAy0CMQuQ4AgJ4+vSpWq2eOHFib6+9BOTE2IJ6MiEXKBSO8BWyGwEZzGaz7NyqhI+QqS4nxibkbCf8Q+ou4+ZkzvGVkvf2NPCrpG03FiyQ/ghA5IcVB1dxkySYTmzOqbrrC1mJMcb4pTVT3r33dGvB8+HrWnqphW9L9Pv4vXV2VsUBgxYw1W7K+eKOuIFdZwq4vwSJFgjCHcg6DwBv5k7JPfTqwlmBlkOaoCWHpuR+PEk1fE2nSdtu5Oty6Vpvs6Nk8tupXjz5SGRuQX3brbbDKwIthzRzC41tbbcOrwq0HP6lp2No2Dppu87wdbkUkYtSmFmnNvmdSC8IRhBOIrDOX64vMK8MtR6GlG6bVm/nm1FLHpW++xwAboUuOzpJutL8n88ZbG/Kbjqh/bjZI3FHBUGR8wItggMWBum83GLqLmYEvHJAv+eig3oN33xbkLwAwJVvpKrd+SJH/wXzr8i+kRlzl6Z5+yZ7kTlLMyICLYNfWDr50w+HyjIHujBkvoc5TGGMYuuR8RdSnkoMVGnbmV4n7T2ycudSo2mVQQuYrnwtts2Bhj3vsd8WOZwIwhM46pyvegEAffnFfSlCHSxQ+faQqJZkMJ2Ls6/7iVFJ5CwtAFPtJoe6HAAa9unJ50j4i/mpExCOvEbFrb29N4FHPw3NL1Fm/gYA5i5F85fC+pERWgCmE5sd6XIAuFuV816VT0QmCEdY1fngTkMfgPtfqTfUsYWM/Z1k+Dmj2WqjD+4s7kkCADSd0DbGmfJjpdvNWMvocpt9z1rzsX9fr5l0pMtHl0OMPCLorQDESKS5oLcZwNLJn36kjAXwG2UsntdI2uUAgIhZGj9KRxAuY9Xcf08CcCvUqssBtNWFlapM+bF9KfOn1bN9fNLxryZooWSqZcTZbbf+qHrW2sGvj05us7WmPDXHvDL0eXL8yyNdozIEL2jJoWCOE/XFhY39P1iPFgbnrg3iVB6XuH1KIue4/eiTusvs/2/mTkmf98vVff93+R5UK1/9YPE4cR1g/MKPJyeGCQotJ7rRX17+QijgrEmrt0+caj3k1Hkzd0o6dwkgbOIHhyZyjvnX4l2EsUXDOTOdgh95Z9fPb4laYuk6sSm3SspB6iRzC42ns22e6vbKDzKKvrcczSmsP5nNdbKn7W1r22s7bK9akVFykz1Ycbhtbxpbwv3ixW1RubXWr6wqbytO5X/ReqKOyhX6Ik4p+43Dt4rTrEecOnML6k9n8aQrvtVWzJGOdy2jiDtDPQDrRuwc8iCEXdCX7IbCuURkVvlBg3UaYb9/Cn5EDha2YhRbjyhCHU5cCJnCqlWd6jmAphahG7y+JSQ/ti8pbhDN7EdtdWEbnGv5yNHJgpJ7j6y/m1GHUFsDCEo/FAz3teC4aZrxC7MnJ4bZinRrpywBX3k7C6v7ecwLXr3y6fFTw0cAuc6KXca9vNVt7aqDRk5slTdGOruI5gdI3mw0pgjjhyVWLjWGg+XYlGsULDo5hUhbA7rsk/XwQAvqXn9jbsEBnpZNLW4rB1ejOw+j+3lEZJ8ub3WvNfljda33HH9SEzElvePJhYgpeY0KALf29lYzzva07VX8vqQ1HDAabIe+3F4hmh9AYzh4JkV0RolQkuTNxl3I+o/b4kbn/5MiFAAmZJZMaHYmkp+QDzwrWTv9pTA4zhx0H5gZ9jIKaIOHvJwVNnwleTJ+oT4IQus5aMkhjoK/3F9+2VoerANrfDtAt3ayDjYbmjGgdfpJqsuD3S7K92Yuq8t5Ei4MXj2D/feH8ic/WApz1wbh0bOTO10+i5vYlszF45cbsJF3nHGWaXZBwa7UBo7Jkvb7VVrhcDw7q2KLm6dd9S/ZOoGFjbmFxgO2Gt8XZcQWWcpPZ0eg4aOoDacdX0vx6VQADdtiN9SCNdmR+ofCObWuThHmFtQzupwn4ZzC+n9h/71ZkhFVYik8ma2znnTU0nzxeeYsJhRu/NIaoAPNBb3NMYqtR8bfFC2cOwFnyVw8oXSdyKwtBi1429jSthsLFmgNW7K+5tjokR/+YzKEu93Sthvf9vD8hPxglTdjhc9817zzISfwTfP08J8ez/TWqTSDyaEAQk7UjT5P+7hpYQBe3OHZzS/qNorc3S7y+LzNev7h3LP58yZODRunBFxTtLMmzZ8HiCcQl/uPeyifXU7v0bew/zJDm0/NcQ6RWYZkoZK+W5WzGRUHDMmGrMiLlnFwdoQWQFfj11xD525VTi4AN7LIzI1+HUB7fR3XvX2zSJ/hzkVw4frMT39euSEtO0I3+w3ANXW+6o9ZOkA0gfi+KCPXUwHly5dPt4rV9u2BT1M4hw37sm6xaWQYI9hf2Q5Sf2/QCJV0wz49thsLFhh+n1plnZgysSlXGnmep4Z9+gZIZkNq/s+B9N8oQvG8hkzzUYdl33nzq6d6ACb4vNjy50VdjsGdf3o8E7j/1av2dr7JmV9+fgQgKN2ru8m5uhwA7g09dqsd1VtBUwHcGHTsDBgVzH4nRSNS0gDudpgAaGZFCEsMB8/sSoPn3Gz9CYAu+6RXd5ML17+Zs7jOit+mAeio/NyxM2BMExoxPtAicEhLSYZISQPoMJkAaGdFCkqSNxsrPnRql/vtgU9TerfSwvloxGoov3KkRPu1dSs5Q8/U/IYXpYY+PHrFM0/7y/UFPeJQu1HE0OWd/dMOBetsAW6+iB17UbfxiRtfU6rHAXhs/sXL4oxEZs3SglHShuGqNuzZHFFxwKBFcsEZYwE8jYOrzV0RbTydHWENcPNJ7FhtbpQbDvC5UbMB4KdWUWQcAQAY+jKz1x3/us9gNsUhebPRuHmYqne+yCnRGgsW2MJThkvwQIxWeFnh2urClm3T2v5K2Lj0+92e6GDLBnQH2WZGAy/qNj4p3/fMYkAHpXs9txrhZe5W5byn1x+4wh5qDAfPGI3b3bbVbxbpo6Jit1nsKV32yTGYW40IAA379Pr3Np2wbP9N3mw0nqnImh1QmYgA4FhPv1yf1gfA9NBtdW7Zpz7KdbmFe4PHNw4Cli1hYRM/yB2S2DDmX3rNv2DeuKnqcYAvgthHFPfumZCsdcnOvrhHz5gyzN62BQUVH+781/NuS1C7IZaxn5ktYWnFxsIfJTaM+ZWbbXcBHV6PnguQgS4H7nSYAI1Ldvadqlx9FWDZ26Y1HPjj43/+iFZXxhKOcrZHLeldGQr0TD3u5jLLGNPlXO4NHj/6AgDU4/1qoM+atFq4Xw7dD4YAYF7Qm/6UJDCwK+Ip77hhmlzcs6nWBEDrnbw3tRs+qGwHEDH7DW805zSrDgv3ywE/3m0HEJGxdI5fRSHchl0RT3HDV3SnKrfkCgDM1Eh15BjF1kblp43KrZtGUqwA4Q3sqfPBncWm0nefAxNOHZ/szsK55unhsaPLZ01afShYoCzfTAwCAPOQKAqdiZsbl5jtoSt+qO3aLwB0eks7giwxVi4/uyoZqbcwePVK0U+665fHAMIm/oP4IznQ8F+1JkBrOCB0NqZt58cKpe4ylmfxY4ci30nWAjCZTK6fd9XhW/WFfGU5d0mGDkDH3R+FldmItrS9nrria/+3AYAu64+WdvhZYqx8X/TvFyERqTensL5cJML3rXcBIK1Y/BHhL+588d9XACwoEK7+zM6q4AVvRmaVG3cJ0gmkvp0MAPe7JDqyJmMCk/sjdPXkpTFelZkINDYvesZaccbWCac+CxMkZJWoFttzjs0eZU3p+nL9aktUvO1TG6PxXSxB6YempAsLX1yQ8LQPXTa+SFwbJMi8Jkzu5gTd3714vHjiVEE7559NXSxQ6kOXK5+9vn3iVFEqusfnnwkbvTfYfGNi+jxMXTw5dzHnQnyWFU6cBMMSm8bLNsNPjwXwEnpw9vPc+aLoRDLjbDQKwuGEaloyYq7rRNEXnXDnfee67JNt2cLC9sotEp722n+r/ENqto6feU2Y3M0ZTv9Pw960NGE7lXezsgVKvTZ3229vFaeJUtHh4jaxdJ9X/SEtS4fU4rZbtlZHa1Y4byHOSsRJncRJdCh8UzCwoMB4hu3vnF1wDXsOvM2s/lg+tXKFfygdMXflwOdS40nXT0MAM1Mfr4oEJDLNEHLFnnU+4dRn2mXbhLqckObe4HFbEBzL4/NPy+2pwMv95aL63jjviwsbn9R9Z6fmxicXbvALb/RLpoT7ofzJyfMyDoO/U5XLCXCzcOWAnrfx/eIeyTp6N4PbazfYguCsp9gWFWtHBX5flCGu74Xztld+EJVR0mqnZtSKqnZeWUflCqmUcDdLMqI+orfhBJqLe7gBbixdJzbxUiDfqcqVrGN30f3LpzV/9a6cxEjhV15aKCQIHtHR0YEWwX3UavU333wTaCmIwBMdHa1Ws2lkZAcjeWurcHan2TQlb/V4UNr2UYejUDiCIAhiVBGjWLN6PAD89Tnp8lHGqEzqQhAEQfCwGOUAgM6BMkryOuogdU74Cpl6KS1iM+87GRbp95ASowPGUy3TnmyHoa/WP/mSIuBGI6TOCZ8g03GQs9wYF2hZiBGB/HsyS9fBJ1sPBlAiwudQKBzhQ5hIokBL4QKSoUMEQT2ZGPmQdU74ENkNKLITmPAPsusYshOY8ByyzgmCIAhC9tBGNYIgCIKQPaTOCYIgCEL2/D+4ZAx97hWpdgAAAABJRU5ErkJggg==" alt="image-20240506151225307"></p></li> <li><p>文件描述符表：<strong>一个数组，它的下标就是文件描述符</strong>，源码<code>/usr/src/linux-headers-5.4.0-150-generic/include/linux/fdtable.h</code></p> <p><img src="/myblog/assets/img/image-20240506151442713.31ba7f7c.png" alt="image-20240506151442713"></p> <blockquote><p>文件描述符的取值总是趋向于<strong>最小可用的</strong>下标</p></blockquote></li> <li><p>描述文件的结构体：源码<code>/usr/src/linux-headers-5.4.0-150-generic/include/linux/fs.h</code></p> <p><img src="/myblog/assets/img/image-20240506153817545.10af010b.png" alt="image-20240506153817545"></p></li></ol> <p>查看进程默认最大可打开的文件描述符数量：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span>
</code></pre></div><h3 id="文件系统"><a href="#文件系统" class="header-anchor">#</a> 文件系统</h3> <p>Linux 的文件系统是一种用于在存储设备上组织管理和访问数据的软件架构，它定义了数据的存储结构与访问方法</p> <p>常见的<strong>本地存储文件系统</strong>：ext2/ext4、xfs、btrfs、jfs</p> <h3 id="inode与dentry"><a href="#inode与dentry" class="header-anchor">#</a> inode与dentry</h3> <ul><li><p>inode 是一个结构体，<strong>存储在磁盘上</strong>，用于描述具体文件或目录的元数据：</p> <ul><li>文件类型</li> <li>文件大小</li> <li>文件所有者及所属组</li> <li>文件的权限</li> <li>文件的时间戳</li> <li><strong>文件在磁盘中的具体位置</strong></li> <li><strong>当前 inode 的硬链接计数</strong></li></ul> <blockquote><p>注意 inode 并不包含文件的名称或路径信息</p> <p><strong>当一个文件的 inode 硬链接计数变为 0 ，并且打开这个文件的所有文件描述符都被关闭了，linux 将删除这个磁盘文件</strong></p></blockquote></li> <li><p>dentry 是一个结构体，<strong>存储在磁盘上</strong>，用于描述具体文件或目录的名称文件：</p> <ul><li><strong>文件名称</strong></li> <li>指向其父目录的 dentry 指针</li> <li><strong>引用的 inode 编号</strong></li></ul> <blockquote><p>dentry 和 inode 的协同工作，实现了从文件名到文件内容的映射</p> <p>可以认为，<strong>Linux 中的硬链接，本质上就是一个 dentry</strong>，每增加一个 dentry，inode 的硬链接计数就会 + 1</p></blockquote></li></ul> <ol><li><p>对于一个目录文件，一定会随之产生两个 dentry，即 <strong>&quot;./&quot;</strong> 和 <strong>&quot;../&quot;</strong>，前者引用的 inode 与当前目录文件的 inode 相同，后者引用的 inode 与父目录文件的 inode 相同。所以，<strong>一个目录文件的硬链接数量，至少是 2，实际的硬链接数量是 2 + 子目录文件的数量</strong></p> <blockquote><p>在 linux 中，无法创建一个目录的硬链接，但是目录确实是有硬链接计数的</p></blockquote></li> <li><p>符号链接是一种特殊的文件，它也有自己的 dentry 和 inode，它的数据是一个路径字符串</p></li></ol> <h3 id="系统调用"><a href="#系统调用" class="header-anchor">#</a> 系统调用</h3> <ul><li>就是 linux 内核提供的 api，所有硬件资源都必须借助系统调用才能间接的访问</li> <li>系统调用的开销：就是 cpu 在用户空间和内核空间之间切换所需要的性能开销</li></ul> <blockquote><p>所有系统调用都可以在 man 手册的第 2 章查到</p></blockquote> <h3 id="库函数"><a href="#库函数" class="header-anchor">#</a> 库函数</h3> <p>所有的库函数都可以在 man 手册的第 3 章查到，它们由两类函数组成：</p> <ul><li><p>底层不需要通过系统调用去实现，只是在用户空间内操作的函数</p></li> <li><p>底层需要通过系统调用去实现，访问内核数据或硬件资源的函数</p> <blockquote><p>大多数库函数实现中，已经根据实际的需要，配置了恰当大小的<strong>用户空间缓冲区</strong>，从而减少系统调用的次数，提高性能；</p> <p>对于我们自己写的程序，如果需要多次系统调用，也应该配置恰当大小的<strong>用户空间缓冲区</strong>，来减少系统调用的次数</p></blockquote></li></ul> <h3 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h3> <p><code>errno</code>是一个全局变量，会记录当前进程最后一次发生错误的，它由各种预定义宏（都是正整数）所表示，初始值为 0</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>  <span class="token comment">// fopen need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span> <span class="token comment">// EXIT_SUCCESS 和 EXIT_FAILURE need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span>  <span class="token comment">// errno need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span> <span class="token comment">// strerror(errno) need</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;xxxx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> fp<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\n&quot;</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 错误码，一个整数</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// strerror返回这个错误码对应的字符串注释</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fopen err&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// perror直接去找errno并获取对应的字符串注释拼接到实参的后面（中间会加一个 : 号）</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>一个代码规范，所有系统调用，在使用之后都必须检查它的返回值，如果有错必须进行错误处理</p> <p>从 c11 开始，<code>errno</code>是线程存储期的</p></blockquote> <p>所有预定义宏：<code>/usr/include/asm-generic/errno-base.h</code>、<code>/usr/include/asm-generic/errno.h</code></p> <h2 id="文件"><a href="#文件" class="header-anchor">#</a> 文件</h2> <h3 id="open"><a href="#open" class="header-anchor">#</a> open</h3> <p>系统调用，打开一个文件</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token comment">// 上述两个头文件使用&lt;unistd.h&gt;就能包含了</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// pathname: 文件路径</span>
<span class="token comment">// flags: 打开行为</span>
<span class="token comment">// mode: 仅当创建文件时生效，预期的八进制 ACL 数</span>
<span class="token comment">// 返回值：成功返回文件描述符，失败返回 -1 并设置 errno</span>
</code></pre></div><blockquote><p>同一个文件，可以多次 open，<strong>但会得到不同的文件描述符</strong></p> <p>每个进程在启动后，默认会打开得到三个文件描述符： <strong>0 STDIN_FILENO 标准输入</strong>、<strong>1 STDOUT_FILENO 标准输出</strong>、<strong>2 STDERR_FILENO 标准错误</strong></p></blockquote> <p>flags 必选项：</p> <ul><li><code>O_RDONLY</code>： 只读方式打开</li> <li><code>O_WRONLY</code>：只写方式打开</li> <li><code>O_RDWR</code>：可读可写方式打开</li></ul> <p>flags 可选项：</p> <ul><li><code>O_CREAT</code>：如果不存在则创建，使用此选项需要设置 mode 参数</li> <li><code>O_TRUNC</code>：如果存在则清空（覆盖）</li> <li><code>O_APPEND</code>：追加</li> <li><code>O_NONBLOCK</code>：对于<strong>设备文件</strong>或<strong>网络文件</strong>以非阻塞方式</li> <li><code>O_SYNC</code>：每次写入操作都会将<strong>内核缓冲区</strong>数据<strong>立即同步</strong>到磁盘上</li> <li><code>O_EXCL</code>：如果与<code>O_CREAT</code>一起使用，将出错</li></ul> <blockquote><p>多个 flag 传入应使用<strong>位或</strong>语法</p></blockquote> <p>umask 掩码：创建一个文件的最终ACL权限，会受到 linux 中的 umask 掩码的干扰，<strong>最终 ACL 权限 = mode &amp; (~umask)</strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">umask</span> <span class="token comment"># 查看当前进程使用的 umask 掩码</span>
<span class="token builtin class-name">umask</span> <span class="token operator">&lt;</span>n<span class="token operator">&gt;</span> <span class="token comment"># 设置当前进程使用的 umask 掩码</span>
</code></pre></div><p>在代码中设置umask掩码</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">mode_t</span> old_umask <span class="token operator">=</span> <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0022</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置新的 umask 并保存旧的 umask 值</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;example.txt&quot;</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to open file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用文件描述符 `fd` 进行文件操作...</span>

    <span class="token comment">// 完成操作后，关闭文件描述符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to close file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">umask</span><span class="token punctuation">(</span>old_umask<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 恢复旧的 umask 值</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="close"><a href="#close" class="header-anchor">#</a> close</h3> <p>系统调用，关闭一个文件</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fd: 需要关闭的文件描述符</span>
<span class="token comment">// 返回值：成功返回 0，失败返回 -1 并设置 errno</span>
</code></pre></div><blockquote><p>任何打开的文件描述符，最终都需要配套 close 将其关闭</p> <p><strong>当进程终止时，这个进程所有打开的文件描述符都会被强制性的 close</strong></p></blockquote> <h3 id="read"><a href="#read" class="header-anchor">#</a> read</h3> <p>系统调用，开辟<strong>内核缓冲区</strong>（如果不存在）加载磁盘文件，并以字节为单位读取内核缓冲区数据到用户空间</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token class-name">ssize_t</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fd: 读入的文件描述符</span>
<span class="token comment">// buf: 读入数据的首地址</span>
<span class="token comment">// count: 预期读入数据的长度（字节数）</span>
<span class="token comment">// 返回值：成功返回实际读入的字节数，失败返回 -1 并设置 errno</span>
<span class="token comment">// 注意：当返回值为 -1，并且 errno 设置成了 EAGAIN 不意味着失败，而表示以非阻塞方式读取且没有读到数据</span>
</code></pre></div><blockquote><p>当调用<code>read</code>函数时，内核会<strong>尽可能多</strong>的加载磁盘文件数据到内核缓冲区中，直至充满内核缓冲区的大小</p></blockquote> <p>==阻塞==：在 IO 操作中，默认读取<strong>设备文件</strong>或<strong>网络文件</strong>时，会产生阻塞现象</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> real <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 标准输入本质上指代的仍是/dev/tty这个终端设备文件，所以默认的读取会阻塞</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;read STDIN_FILENO failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> real<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>==非阻塞==：指定了以非阻塞方式打开<strong>设备文件</strong>或<strong>网络文件</strong>时，不产生阻塞现象</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/tty&quot;</span><span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 新打开终端设备文件，并在 open 指定了非阻塞</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;open /dev/tty failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> real <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>real <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 以非阻塞方式读取但没有数据</span>
            <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">&quot;try again\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;try again\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>count<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 读取失败</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;read /dev/tty failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">==</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 读了5次认定超时</span>
        <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">&quot;arrive 5 times, timeout!\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;arrive 5 times, timeout!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取成功且有数据</span>
    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="write"><a href="#write" class="header-anchor">#</a> write</h3> <p>系统调用，开辟<strong>内核缓冲区</strong>（如果不存在），并以字节为单位将数据（用户空间）写出到内核缓冲区中，<strong>最后择机同步到磁盘文件上</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token class-name">ssize_t</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fd: 写出的文件描述符</span>
<span class="token comment">// buf: 写出数据的首地址</span>
<span class="token comment">// count: 预期写出数据的长度（字节数）</span>
<span class="token comment">// 返回值：成功返回实际写出的字节数，失败返回 -1 并设置 errno</span>
</code></pre></div><blockquote><p>通常来说，<code>write</code>函数比<code>read</code>函数看上去较快，是因为<code>write</code>函数将数据写出到内核缓冲区就直接返回了，而<code>read</code>函数有时需要磁盘 IO 操作将数据读取到内核缓冲区，这个时长是较慢的</p></blockquote> <p>用 <code>read</code>和<code>write</code>实现一个复制命令</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ARR_SIZE</span><span class="token expression"><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查命令行参数的数量</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;there are at least 2 parameters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 打开两个文件描述符</span>
    <span class="token keyword">int</span> fd_src <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> fd_src<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// open出错</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;open src failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> fd_dst <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> fd_dst<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// open出错</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;open dst failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 复制逻辑</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd_src<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">ARR_SIZE</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// read出错</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;read src failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 实际读多少实际写多少</span>
        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd_dst<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// write出错</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;write dst failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 关闭文件描述符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">close</span><span class="token punctuation">(</span>fd_src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">close</span><span class="token punctuation">(</span>fd_dst<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 不要使用短路逻辑</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;close src or dst failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;copy %s to %s complete! \n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="fsync"><a href="#fsync" class="header-anchor">#</a> fsync</h3> <p>系统调用，将内核缓冲区数据（包括文件的元数据）同步到磁盘上</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">fsync</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fd: 文件描述符</span>
<span class="token comment">// 返回值：成功返回 0；失败返回 -1 并设置 errno</span>
</code></pre></div><blockquote><p>注意<code>fsync</code>是一种阻塞操作，会影响程序性能</p> <p>变种<code>fdatasync</code>函数：只同步内核缓冲区中的数据部分，不包含文件的元数据，<strong>即对磁盘的访问只有一次</strong>，稍微没<code>fsync</code>那么影响程序性能</p> <p>变种<code>sync</code>函数：不针对具体文件，而是将所有文件的内核缓冲区数据（包括文件的元数据）同步到磁盘上；因为非常影响系统性能，所以只在系统关机之前使用</p> <p>对于<code>write</code>，不需要我们手动同步，因为Linux 会在适当时机自动将内核缓冲区同步到磁盘上，但如果写入 0 个字节，不会生效</p> <p><strong>无论是多进程还是单进程，同一份文件，不会在内核缓冲区中加载多份，同一文件的多个文件描述符始终访问的是内核缓冲区（如果存在）中的唯一一份最新数据</strong></p></blockquote> <p>确保写入操作被同步到磁盘上</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;example.txt&quot;</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error opening file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">&quot;Hello, world!\n&quot;</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error writing to file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 确保写入操作被同步到磁盘上（对于现代操作系统来说其实是不必要的）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fsync</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error syncing file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="lseek"><a href="#lseek" class="header-anchor">#</a> lseek</h3> <p>系统调用，调整文件的偏移位置</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token class-name">off_t</span> <span class="token function">lseek</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> whence<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fd: 文件描述符</span>
<span class="token comment">// offset: 相较于 whence 的偏移量；正数向后偏移，负数向前偏移，0 不偏移</span>
<span class="token comment">// whence: 偏移的基准位置；SEEK_SET 文件起始位置、SEEK_CUR 文件当前位置、SEEK_END 文件末尾（最后一个字节之后即 EOF 的位置）</span>
<span class="token comment">// 返回值：成功返回相较于文件起始位置的实际偏移量，失败返回 -1 并设置 errno</span>
</code></pre></div><blockquote><p>并不是所有文件都可以使用<code>lseek</code>，管道或 SOCKET 就不行</p></blockquote> <p>借助<code>lseek</code>对同一个文件读写</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> msg <span class="token operator">=</span> <span class="token string">&quot;this is a test!!! \n&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;lseek.txt&quot;</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;open lseek.txt failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写出数据，并且此时文件的偏移位置会发生改变</span>

    <span class="token comment">// 打开的文件中有一个记录偏移位置的成员，任何读写操作使用的都是同一个成员</span>
    <span class="token comment">// 所以当对同一个文件进行读写操作时，需要使用 lseek 适当的调整文件的偏移位置</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 将偏移位置拉到文件的起始位置</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;lseek call failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> ch<span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> n<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ch<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;read failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ch<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>利用<code>lseek</code>获取文件的大小</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Usage: %s &lt;file&gt; \n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打开文件</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 调整偏移位置到文件末尾</span>
    <span class="token class-name">off_t</span> file_size <span class="token operator">=</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> file_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error seeking in file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Size of %s is %ld bytes. \n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>file_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>利用<code>lseek</code>和<code>write</code>拓展一个文件的大小</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Usage %s &lt;file&gt; \n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打开文件</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;open failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用 lseek 调整到指定的偏移位置</span>
    <span class="token class-name">off_t</span> new_size <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> new_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;lseek failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用 lseek 拓展文件时，必须配合 write 写入实际的字节，否则无效</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 随便写入一个字节，不能写入 0 字节</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;write failed, expand file failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s expand to 1024 bytes success! \n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="truncate"><a href="#truncate" class="header-anchor">#</a> truncate</h3> <p>系统调用，裁剪文件的大小</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token class-name">off_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// path: 文件的路径</span>
<span class="token comment">// length: 文件的新大小（字节数）</span>
</code></pre></div><blockquote><p>变种<code>ftruncate</code>函数：将指定<strong>具有写权限</strong>的<strong>文件描述符</strong>进行裁剪</p></blockquote> <p>简单示例</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FILENAME</span> <span class="token string">&quot;sample.txt&quot;</span></span>

<span class="token comment">// 简单的错误校验</span>
<span class="token keyword">void</span> <span class="token function">check_error</span><span class="token punctuation">(</span><span class="token keyword">int</span> result<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 打印文件内容</span>
<span class="token keyword">void</span> <span class="token function">print_file_contents</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FILE <span class="token operator">*</span>file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fopen&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Contents of %s:\n&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> ch<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ch <span class="token operator">=</span> <span class="token function">fgetc</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">putchar</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>initial_data <span class="token operator">=</span> <span class="token string">&quot;Hello, Linux System Programming!&quot;</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>FILENAME<span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_WRONLY<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">check_error</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">check_error</span><span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> initial_data<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>initial_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_file_contents</span><span class="token punctuation">(</span>FILENAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将文件裁剪到 10 字节</span>
    <span class="token function">check_error</span><span class="token punctuation">(</span><span class="token function">truncate</span><span class="token punctuation">(</span>FILENAME<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;truncate to 10 bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_file_contents</span><span class="token punctuation">(</span>FILENAME<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello, Lin</span>

    <span class="token comment">// 将文件扩展到 40 字节</span>
    <span class="token function">check_error</span><span class="token punctuation">(</span><span class="token function">truncate</span><span class="token punctuation">(</span>FILENAME<span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;truncate to 40 bytes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_file_contents</span><span class="token punctuation">(</span>FILENAME<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello, Lin一堆文件空洞</span>
    
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="fcntl"><a href="#fcntl" class="header-anchor">#</a> fcntl</h3> <p>系统调用，设置一个<strong>已经打开的文件</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fd: 已经打开的文件描述符</span>
<span class="token comment">// cmd: fcntl预定义的各种指令</span>
<span class="token comment">// ...: 可变参数</span>
</code></pre></div><p>不使用<code>open</code>函数设置一个已经打开的文件的 flags</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 flags</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fcntl failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    flags <span class="token operator">|=</span> O_NONBLOCK<span class="token punctuation">;</span> <span class="token comment">// 追加 flag</span>
    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置 flags</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fcntl failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> real <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>real <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 以非阻塞方式读取但没有数据</span>
            <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">&quot;try again\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;try again\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>count<span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 读取失败</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;read /dev/tty failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">==</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 读了5次认定超时</span>
        <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">&quot;arrive 5 times, timeout!\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;arrive 5 times, timeout!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取成功且有数据</span>
    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> real<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="stat"><a href="#stat" class="header-anchor">#</a> stat</h3> <p>系统调用，获取文件的状态信息</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">stat</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">stat</span> <span class="token operator">*</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// pathname: 文件路径</span>
<span class="token comment">// statbuf: 记录文件状态信息的结构体</span>
<span class="token comment">// 返回值：成功返回 0，失败返回 -1 并设置 errno</span>

<span class="token comment">// 记录文件状态信息的结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">stat</span> <span class="token punctuation">{</span>
	<span class="token class-name">dev_t</span> st_dev<span class="token punctuation">;</span> <span class="token comment">// 包含文件的设备 id</span>
    <span class="token class-name">ino_t</span> st_ino<span class="token punctuation">;</span> <span class="token comment">// 文件的 inode 号</span>
    <span class="token class-name">mode_t</span> st_mode<span class="token punctuation">;</span> <span class="token comment">// 使用“两字节的位图”记录了文件类型以及权限</span>
    <span class="token class-name">nlink_t</span> st_link<span class="token punctuation">;</span> <span class="token comment">// 硬链接数量</span>
    <span class="token class-name">uid_t</span> st_uid<span class="token punctuation">;</span> <span class="token comment">// user id</span>
    <span class="token class-name">gid_t</span> st_gid<span class="token punctuation">;</span> <span class="token comment">// group id</span>
    <span class="token class-name">dev_t</span> st_rdev<span class="token punctuation">;</span> <span class="token comment">// 设备 id（如果是一个特殊设备）</span>
    <span class="token class-name">off_t</span> st_size<span class="token punctuation">;</span> <span class="token comment">// 文件大小（字节数）</span>
    <span class="token class-name">blksize_t</span> st_blksize<span class="token punctuation">;</span> <span class="token comment">// 块大小</span>
    <span class="token class-name">blkcnt_t</span> st_blocks<span class="token punctuation">;</span> <span class="token comment">// 块数</span>
    
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_atim<span class="token punctuation">;</span> <span class="token comment">// 文件最后一次访问时间</span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_mtim<span class="token punctuation">;</span> <span class="token comment">// 文件内容最后一次修改时间</span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> st_ctim<span class="token punctuation">;</span> <span class="token comment">// 文件状态最后一次修改时间</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>下面是一些预定义宏，将<code>st_mode</code>字段与其<strong>位与操作</strong>可以得知是否为某种文件类型或者具有某种权限</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token number">0</span><span class="token operator">-</span><span class="token number">2</span>bit<span class="token operator">:</span> 其他人权限
    <span class="token operator">-</span> S_IROTH <span class="token number">100</span> 读   除了一个标志位是 <span class="token number">1</span> 其他标志位全是<span class="token number">0</span>
    <span class="token operator">-</span> S_IWOTH <span class="token number">010</span> 写   除了一个标志位是 <span class="token number">1</span> 其他标志位全是<span class="token number">0</span>
    <span class="token operator">-</span> S_IXOTH <span class="token number">001</span> 执行   除了一个标志位是 <span class="token number">1</span> 其他标志位全是<span class="token number">0</span>
    <span class="token operator">-</span> S_IRWXO <span class="token number">111</span> 掩码，  除了这三个标志位是 <span class="token number">1</span> 其他标志位全是 <span class="token number">0</span>

<span class="token number">3</span><span class="token operator">-</span><span class="token number">5</span>bit<span class="token operator">:</span> 所有组权限
    <span class="token operator">-</span> S_IRGRP <span class="token number">100</span> 读   除了一个标志位是 <span class="token number">1</span> 其他标志位全是<span class="token number">0</span>
    <span class="token operator">-</span> S_IWGRP <span class="token number">010</span> 写   除了一个标志位是 <span class="token number">1</span> 其他标志位全是<span class="token number">0</span>
    <span class="token operator">-</span> S_IXGRP <span class="token number">001</span> 执行   除了一个标志位是 <span class="token number">1</span> 其他标志位全是<span class="token number">0</span>
    <span class="token operator">-</span> S_IRWXG <span class="token number">111</span> 掩码，  除了这三个标志位是 <span class="token number">1</span> 其他标志位全是 <span class="token number">0</span>
    
<span class="token number">6</span><span class="token operator">-</span><span class="token number">8</span>bit<span class="token operator">:</span> 所有者权限
    <span class="token operator">-</span> S_IRUSR <span class="token number">100</span> 读   除了一个标志位是 <span class="token number">1</span> 其他标志位全是<span class="token number">0</span>
    <span class="token operator">-</span> S_IWUSR <span class="token number">010</span> 写   除了一个标志位是 <span class="token number">1</span> 其他标志位全是<span class="token number">0</span>
    <span class="token operator">-</span> S_IXUSR <span class="token number">001</span> 执行   除了一个标志位是 <span class="token number">1</span> 其他标志位全是<span class="token number">0</span>
    <span class="token operator">-</span> S_IRWXU <span class="token number">111</span> 掩码，  除了这三个标志位是 <span class="token number">1</span> 其他标志位全是 <span class="token number">0</span>
    
<span class="token number">9</span><span class="token operator">-</span><span class="token number">11</span>bit<span class="token operator">:</span> 特殊权限位，不知道做什么用
    
<span class="token number">12</span><span class="token operator">-</span><span class="token number">15</span>bit<span class="token operator">:</span> 文件类型<span class="token punctuation">,</span> 四个可能为 <span class="token number">1</span> 的标志位组合表示唯一文件类型
    <span class="token operator">-</span> S_IFREG 普通文件   除了四个标志位以外其他标志位全是 <span class="token number">0</span>
    <span class="token operator">-</span> S_IFDIR 目录文件   除了四个标志位以外其他标志位全是 <span class="token number">0</span>
    <span class="token operator">-</span> S_IFCHR 字符设备文件   除了四个标志位以外其他标志位全是 <span class="token number">0</span>
    <span class="token operator">-</span> S_IFBLK 块设备文件   除了四个标志位以外其他标志位全是 <span class="token number">0</span>
    <span class="token operator">-</span> S_IFLNK 符号链接文件   除了四个标志位以外其他标志位全是 <span class="token number">0</span>
    <span class="token operator">-</span> S_IFIFO 管道文件   除了四个标志位以外其他标志位全是 <span class="token number">0</span>
    <span class="token operator">-</span> S_IFSOCK 本地 socket 文件   除了四个标志位以外其他标志位全是 <span class="token number">0</span>
    <span class="token operator">-</span> S_IFMT 掩码   除了四个标志位是 <span class="token number">1</span> 其他标志位全是 <span class="token number">0</span>
</code></pre></div><p>简单示例</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sysmacros.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Usage %s &lt;file&gt; \n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">stat</span> sb<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">stat</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;stat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 利用掩码宏跟位与操作判断文件类型，比较抽象</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IFMT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> S_IFREG<span class="token operator">:</span> <span class="token comment">// 普通文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;regular file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> S_IFDIR<span class="token operator">:</span> <span class="token comment">// 目录文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;directory file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> S_IFCHR<span class="token operator">:</span> <span class="token comment">// 字符设备文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;character device file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> S_IFBLK<span class="token operator">:</span> <span class="token comment">// 块设备文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;block device file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> S_IFLNK<span class="token operator">:</span> <span class="token comment">// 符号链接文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;symbol link file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> S_IFIFO<span class="token operator">:</span> <span class="token comment">// 管道文件 这个宏命名有点搞笑，需要注意以下</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;fifo pipe file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> S_IFSOCK<span class="token operator">:</span> <span class="token comment">// 本地 socket 文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;socket file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;unknown file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 借助宏函数判断文件类型，最简单</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISREG</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 普通文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;regular file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 目录文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;directory file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISCHR</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 字符设备文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;character device file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISBLK</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 块设备文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;block device file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISLNK</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 符号链接文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;symbol link file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISFIFO</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 管道文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;fifo pipe file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISSOCK</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 本地 socket 文件</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;socket file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;unknown file \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 利用宏跟位与操作获取文件权限</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>S_IRUSR <span class="token operator">&amp;</span> sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span>  <span class="token comment">// 写成 S_IRUSR &amp; sb.st_mode == S_IRUSR的逻辑更合理贴切</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;user r \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>S_IWUSR <span class="token operator">&amp;</span> sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> 
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;user w \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>S_IXUSR <span class="token operator">&amp;</span> sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> 
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;user x \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>S_IRGRP <span class="token operator">&amp;</span> sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">==</span> S_IRGRP<span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;group r \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>S_IWGRP <span class="token operator">&amp;</span> sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">==</span> S_IWGRP<span class="token punctuation">)</span> 
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;group w \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>S_IXGRP <span class="token operator">&amp;</span> sb<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">==</span> S_IXGRP<span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;group x \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>S_IROTH <span class="token operator">==</span> <span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IROTH<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;other r \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>S_IWOTH <span class="token operator">==</span> <span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IWOTH<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;other w \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>S_IXOTH <span class="token operator">==</span> <span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IXOTH<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;other x \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 上述两种位与操作的原理：1. 若 A &amp; B == B 则 =&gt; B ⊆ A, ≠&gt; A == B ; 2. 若 A &amp; B == C, 且 B 标志位全为 1, 则 A == C</span>
    
    <span class="token comment">// 文件时间相关</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;last access time: %s&quot;</span><span class="token punctuation">,</span> <span class="token function">ctime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sb<span class="token punctuation">.</span>st_ctime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件的最后一次访问时间</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;last file modification: %s&quot;</span><span class="token punctuation">,</span> <span class="token function">ctime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sb<span class="token punctuation">.</span>st_ctime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件内容的最后一次修改时间</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;last file status change: %s&quot;</span><span class="token punctuation">,</span> <span class="token function">ctime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sb<span class="token punctuation">.</span>st_ctime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件状态的最后一次修改时间</span>

    <span class="token comment">// 其他信息</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;file size: %lld bytes \n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>sb<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件大小</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;inode: %ld \n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>sb<span class="token punctuation">.</span>st_ino<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// inode 号</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hard link count: %ld \n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>sb<span class="token punctuation">.</span>st_nlink<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 硬连接数</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;ownership: uid = %ld, gid = %ld \n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>sb<span class="token punctuation">.</span>st_uid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>sb<span class="token punctuation">.</span>st_gid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 所有者 id 与所有组 id</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I/O block size: %ld bytes \n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>sb<span class="token punctuation">.</span>st_blksize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 块大小</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;blocks allocated: %lld \n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>sb<span class="token punctuation">.</span>st_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 块数</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;id of containing device: [%lx, %lx] \n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">major</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_dev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">minor</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span>st_dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 包含这个文件的设备 id，major 和 minor 需要头文件&lt;sys/sysmacros.h&gt;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>注意，对于符号链接文件，<code>stat</code>函数会穿透这个符号链接获取到目标文件的状态信息，而不是符号链接文件本身的状态信息</p> <p>变种<code>lstat</code>函数：与<code>stat</code>函数几乎一样，唯一的区别就是它不会穿透符号链接，而是直接获取符号链接文件本身的状态信息</p></blockquote> <h3 id="readlink"><a href="#readlink" class="header-anchor">#</a> readlink</h3> <p>系统调用，读取一个<strong>符号链接文件</strong>所存储的目标路径字符串</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token class-name">ssize_t</span> <span class="token function">readlink</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> bufsiz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// pathname: 符号链接文件的路径</span>
<span class="token comment">// buf: 存放路径字符串的buffer</span>
<span class="token comment">// bufsiz: 期待读取到buffer中的字节数</span>
<span class="token comment">// 返回值：成功返回实际读到的字节数，失败返回 -1 并设置 errno</span>
</code></pre></div><p>简单示例</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> len <span class="token operator">=</span> <span class="token function">readlink</span><span class="token punctuation">(</span><span class="token string">&quot;./p.s&quot;</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;readlink&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 注意 readlink 读取到路径字符串并不会在末尾自动添加 '\0'，所以我们需要手动添加</span>
    buf<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;the link points to: %s \n&quot;</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="link"><a href="#link" class="header-anchor">#</a> link</h3> <p>系统调用，创建一个<strong>硬链接</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">link</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>oldpath<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>newpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// oldpath: 现有文件的路径</span>
<span class="token comment">// newpath: 新文件（硬链接）的路径</span>
<span class="token comment">// 返回值：成功返回 0；失败返回 -1 并设置 errno</span>
</code></pre></div><blockquote><p>无法对一个目录使用<code>link</code></p> <p><code>link</code>不会发生穿透：如果是符号链接文件，则创建这个符号链接文件本身的硬链接</p></blockquote> <p>简单示例</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">!=</span> argc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Usage %s &lt;old_file&gt; &lt;new_file&gt; \n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">link</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hard link created successfully. \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;link&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="unlink"><a href="#unlink" class="header-anchor">#</a> unlink</h3> <p>系统调用，删除一个<strong>硬链接</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// pathname: 现有文件的路径</span>
<span class="token comment">// 返回值：成功返回 0；失败返回 -1 并设置 errno</span>
</code></pre></div><blockquote><p>无法对一个目录使用<code>unlink</code></p> <p><code>unlink</code>不会发生穿透：如果是符号链接文件，则删除这个符号链接文件的硬链接</p> <p><code>unlink</code>会导致文件的硬链接计数 -1。<strong>当文件的硬链接计数减为 0 ，并且任何进程打开这个文件的文件描述符都被关闭了，linux 才会将这个磁盘文件删除</strong></p></blockquote> <p>创建一个仅在当前进程中存活，并且仅在当前进程中可访问的临时文件</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">!=</span> argc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Usage %s &lt;temp_file&gt; \n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 刚 open 就将其 unlink，使得其他进程无法通过文件名发现这个临时文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">unlink</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;unlink&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 向临时文件写入 4gb 的数据</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token char">'a'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1048576</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;4gb of data has been written to %s file \n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> shell <span class="token operator">=</span> <span class="token string">&quot;df ./&quot;</span><span class="token punctuation">;</span> <span class="token comment">// shell命令，用于显示磁盘消耗情况</span>
    
    <span class="token function">system</span><span class="token punctuation">(</span>shell<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件描述符，此时已经满足临时文件被 linux 所删除的条件</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;after close fd \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">system</span><span class="token punctuation">(</span>shell<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="进程控制"><a href="#进程控制" class="header-anchor">#</a> 进程控制</h2> <h3 id="进程状态"><a href="#进程状态" class="header-anchor">#</a> 进程状态</h3> <ul><li><p>新建态：进程刚刚被创建</p></li> <li><p>就绪态：进程已经准备好运行，等待 cpu 划分时间片</p></li> <li><p>运行态：获取 cpu 时间片，执行运算</p></li> <li><p>阻塞态：主动放弃 cpu，等待除cpu以外的其他资源</p></li> <li><p>终止态：正常或者异常终止进程</p> <blockquote><p>进程终止：</p> <ol><li>关闭所有文件描述符</li> <li>释放用户空间分配的内存</li> <li><strong>进程的 PCB 会残留在内核空间，用于保存终止时的状态（正常退出值或者异常退出的终止信号）</strong></li></ol></blockquote></li></ul> <h3 id="进程号"><a href="#进程号" class="header-anchor">#</a> 进程号</h3> <ul><li><p><code>getpid</code>：系统调用，获取当前进程id</p></li> <li><p><code>getppid</code>：系统调用，获取父进程id</p></li> <li><p><code>getpgid</code>：系统调用，传入参数0(当前进程)或者指定进程id，返回所在进程组id</p></li> <li><p><code>getuid</code>：系统调用，获取当前进程的实际用户id</p></li> <li><p><code>geteuid</code>：系统调用，获取当前进程的有效用户id，比如说使用sudo改变的有效用户id</p></li></ul> <blockquote><ol><li>使用<code>ps aux</code>命令查看所有进程id，以及用户、cpu和内存使用率</li> <li>使用<code>ps ajx</code>命令查看所有进程以及父进程id，以及进程组和会话id；<strong>通常子进程 id是父进程 id + 1（或者往后顺延 + 1）</strong></li> <li>使用<code>ps -p &lt;进程id&gt;</code>查看指定进程id的进程信息</li> <li>所有进程最终都可以追溯到一个<strong>祖先进程init</strong>，但在现代的linux版本中，已经将这个进程替换成了<strong>systemd进程</strong>，原先的<code>/sbin/init</code>成为了<code>/lib/systemd/systemd</code>的符号链接（软链接）</li></ol></blockquote> <h3 id="fork"><a href="#fork" class="header-anchor">#</a> fork</h3> <p>系统调用，以当前进程使用的所有代码为蓝本，创建一个子进程，并且子进程执行的是<code>fork</code>函数之后的代码</p> <ul><li>对于父进程，成功返回子进程的pid，失败返回-1并设置errno</li> <li>对于子进程，成功返回0</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;before fork \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 子进程具有这里的代码，但它不会执行</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fork失败</span>
        <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">&quot;fork error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am child, my pid = %d, my parent_pid = %d \n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, my pid = %d, my child_pid = %d \n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;after fork \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 子进程和父进程都会执行</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><ol><li><p><strong>与c++多线程编程不同，父进程结束，子进程不会跟着结束</strong></p></li> <li><p>子进程和父进程对于cpu的争抢是同级别的，即谁先执行谁后执行是不一定的</p></li></ol></blockquote> <p><strong>刚<code>fork</code></strong>，父子进程的异同点</p> <ul><li>相同：整个用户空间、用户id、进程工作目录、家目录、信号处理方式</li> <li>不同：进程id以及父进程id、fork的返回值、进程运行时间、定时器、未决信号集</li></ul> <blockquote><p>注意，对于父子进程的相同点，采用的是<strong>读时共享写时复制</strong>机制</p> <p>那有没有父子进程直接共享，而不采用复制的呢？有，就是<strong>打开的文件描述符</strong>以及<strong>mmap建立的映射区</strong></p></blockquote> <p>==循环创建多个子进程==</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 这里的变量是所有进程中都会独立创建的，值可能是不同的</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 在循环中仅支持父进程执行fork</span>
        <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 防止子进程继续fork</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 在公共逻辑中，区分父进程和子进程</span>
    <span class="token comment">// 方法1：使用循环变量的值来区分</span>
    <span class="token comment">// 方法2：使用fork的返回值来区分，这是更标准、统一的写法</span>

    <span class="token comment">// 下面是用的是循环变量的值来区分</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am %dth child \n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在gdb中调试父子进程，在<code>fork</code>函数调用之前</p> <ul><li>调试父进程：<code>set follow-fork-mode parent</code>（默认）</li> <li>调试子进程：<code>set follow-fork-mode child</code></li></ul> <h3 id="exec"><a href="#exec" class="header-anchor">#</a> exec</h3> <p>库函数，执行一个新的可执行程序，并将当前进程的<strong>用户空间</strong>替换为该可执行程序</p> <ul><li>一旦调用成功，直接执行新的可执行程序去了，不会返回；仅当调用失败时才会返回 -1 并设置 errno；</li> <li>在子进程的逻辑中，调用完<code>execxxx</code>之后直接使用<code>perror</code>和<code>exit</code>，而无需<code>if</code>判断</li></ul> <ol><li><p><code>execl</code>：搜索**路径(绝对路径或相对路径)**来执行指定的可执行文件</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fork失败</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-F&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-a&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 参数1：可执行文件的路径</span>
        <span class="token comment">// 参数2：可执行程序名</span>
        <span class="token comment">// 参数3：可变参数（必须以NULL结尾）</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execute /bin/ls error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>execlp</code>：搜索<strong>环境变量PATH</strong>来执行指定的可执行文件</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-F&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-a&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 参数1：可执行文件的搜索路径</span>
        <span class="token comment">// 参数2：可执行程序名</span>
        <span class="token comment">// 参数3：可变参数（必须以NULL结尾）</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execute /bin/ls error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>execle</code>：搜索<strong>路径(绝对路径或相对路径)<strong>来执行指定的可执行文件，并且替换当前进程</strong>所有的环境变量</strong>为<strong>指定的环境变量</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fork失败</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token keyword">char</span><span class="token operator">*</span> new_env<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;PATH=/usr/bin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TERM=xterm&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">execle</span><span class="token punctuation">(</span><span class="token string">&quot;/usr/bin/env&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> new_env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 参数1：可执行文件的路径</span>
        <span class="token comment">// 参数2：可执行程序名</span>
        <span class="token comment">// 参数3：可变参数（必须以NULL结尾）</span>
        <span class="token comment">// 参数4：环境变量字符串数组（必须以NULL结尾）</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execle failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>execv</code>：搜索**路径(绝对路径或相对路径)**来执行指定的可执行文件</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fork失败</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token keyword">char</span><span class="token operator">*</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-F&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">execv</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/ls&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 参数1：可执行文件的路径</span>
        <span class="token comment">// 参数2：可执行程序名、所有参数、NULL结尾构成的字符串数组</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execle failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>execvp</code>：搜索<strong>环境变量PATH</strong>来执行指定的可执行文件</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fork失败</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token keyword">char</span><span class="token operator">*</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-F&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">execvp</span><span class="token punctuation">(</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 参数1：可执行文件的搜索路径</span>
        <span class="token comment">// 参数2：可执行程序名、所有参数、NULL结尾构成的字符串数组</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execle failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>execve</code>：搜索<strong>路径(绝对路径或相对路径)<strong>来执行指定的可执行文件，并且替换当前进程</strong>所有的环境变量</strong>为<strong>指定的环境变量</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fork失败</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token keyword">char</span><span class="token operator">*</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> new_env<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;PATH=/usr/bin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TERM=xterm&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">&quot;/usr/bin/env&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> new_env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 参数1：可执行文件的路径</span>
        <span class="token comment">// 参数2：可执行程序名、所有参数、NULL结尾构成的字符串数组</span>
        <span class="token comment">// 参数3：环境变量字符串数组（必须以NULL结尾）</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execle failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="进程回收"><a href="#进程回收" class="header-anchor">#</a> 进程回收</h3> <p><strong>父进程尚未终止的情况下</strong>，<strong>义务性的</strong>通过<strong>回收函数</strong>回收子进程终止态残留在内核空间的 PCB；<strong>注意只有父子进程存在回收关系</strong></p> <ul><li>与c++多线程编程不同，在父进程即将终止时，是<strong>无义务</strong>对子进程回收的，直接让这个子进程成为<strong>孤儿进程</strong>即可</li> <li><strong>只有已终止但未执行过回收函数的子进程，或者是未终止的子进程，才是可回收的</strong>；<strong>已经终止并且已执行过回收函数的子进程是不可回收的</strong></li></ul> <ol><li><p><code>wait</code>：系统调用，以<strong>阻塞式</strong>的等待<strong>任意一个可回收的</strong>子进程终止，<strong>并且回收这个子进程残留在内核中的 PCB</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fork失败</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am child, pid = %d \n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 人为制造一个除零错误</span>

        <span class="token comment">/* 制造一个段错误
        char* str = &quot;hello world&quot;;
        str[1] = 'a'; 

        */</span>
        
        <span class="token comment">/* 正常退出
        sleep(3);
        exit(255); // 手动给一个退出码
        */</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程</span>
        <span class="token class-name">pid_t</span> wpid<span class="token punctuation">;</span>
        <span class="token keyword">int</span> wstatus<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            wpid <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wstatus<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token comment">// 传出参数：用来获取子进程的终止状态，需要在后续配合宏函数来获取其中的细节；当然，也可以传NULL</span>
            <span class="token comment">// 返回值：大于0则表示等待的子进程**已终止**，且该值就是这个子进程的pid；如果没有子进程可回收则返回-1并设置errno为ECHILD，如果wait函数被信号中断也返回-1并设置errno为EINTR</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> wpid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;wait failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>wstatus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果子进程正常退出，则宏函数返回非0</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wait child %d complete, child exit code = %d \n&quot;</span><span class="token punctuation">,</span> wpid<span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>wstatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// WEXITSTATUS宏函数只能在子进程正常退出的情况下，才能获取到退出码（获取的退出码必定在[0-255]之间，即任何超过这个范围的退出码都会用来对256取模）</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>wstatus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果子进程受到信号终止（包括异常终止），则宏函数返回非0</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wati child %d complete, child signal code = %d \n&quot;</span><span class="token punctuation">,</span> wpid<span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>wstatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// WTERMSIG宏函数只能在子进程受到信号终止的情况下，才能获取到信号值</span>
        <span class="token punctuation">}</span> <span class="token comment">// 类似的用来处理子进程终止状态值的宏函数还有很多，可以在 man 手册中查阅</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>waitpid</code>：系统调用，<strong>选项式</strong>的等待一个<strong>可回收的</strong>子进程（可指定）终止，<strong>并且回收这个子进程残留在内核中的 PCB</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span> <span class="token comment">// need</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token comment">// 子进程1的逻辑</span>
<span class="token keyword">void</span> <span class="token function">do_child1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am child1, my id = %d, my parent id = %d \n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 子进程2的逻辑</span>
<span class="token keyword">void</span> <span class="token function">do_child2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am child2, my id = %d, my parent id = %d \n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">202</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 父进程的逻辑：逐个回收多个指定的子进程</span>
<span class="token keyword">void</span> <span class="token function">do_parent</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> childs<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> wpid1<span class="token punctuation">,</span> wpid2<span class="token punctuation">;</span>
    <span class="token keyword">int</span> wstatus1<span class="token punctuation">,</span> wstatus2<span class="token punctuation">,</span> should_wait_child1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> should_wait_child2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>should_wait_child1<span class="token punctuation">)</span> <span class="token comment">// 防止二次回收</span>
            wpid1 <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span>childs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wstatus1<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// WNOHANG表示无阻塞式的等待</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>should_wait_child2<span class="token punctuation">)</span>
            wpid2 <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span>childs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wstatus2<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 参数1：大于0表示等待指定的子进程；等于0表示等待同一个进程组的任意一个子进程；等于-1表示等待任意一个子进程；小于-1表示等待的任意一个子进程，且这个子进程的进程组id等于这个参数的绝对值</span>
        <span class="token comment">// 参数2：用来获取子进程的终止状态，需要在后续配合宏函数来获取其中的细节</span>
        <span class="token comment">// 参数3：指定等待选项，传入WNOHANG表示无阻塞式等待，传入0表示阻塞式等待</span>
        <span class="token comment">// 返回值：等于0表示在无阻塞式等待时子进程尚未终止；大于0则表示等待的子进程**已终止**，且该值就是这个子进程的pid；如果没有子进程可回收则返回-1并设置errno为ECHILD，如果wait函数被信号中断也返回-1并设置errno为EINTR</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> wpid1<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程1未终止</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wait child1 no complete, I will do otherthing... \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>should_wait_child1 <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> wpid1 <span class="token operator">==</span> childs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程1已终止</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>wstatus1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程1正常退出</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wait child1 %d is complete!!! child1 exit code = %d \n&quot;</span><span class="token punctuation">,</span> wpid1<span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>wstatus1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>wstatus1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程1信号终止</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wait child1 %d is complete!!! child1 signal code = %d \n&quot;</span><span class="token punctuation">,</span> wpid1<span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>wstatus1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            should_wait_child1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> wpid1<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 等待失败，这里如果写成 else 就会掉入编程陷阱</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wait child1 failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wpid1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> wpid2<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程2未结束</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wait child2 no complete, I will do otherthing... \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>should_wait_child2 <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> wpid2 <span class="token operator">==</span> childs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程2已终止</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>wstatus2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程2正常退出</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wait child2 %d is complete!!! child2 exit code = %d \n&quot;</span><span class="token punctuation">,</span> wpid2<span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>wstatus2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>wstatus2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程2信号终止</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wait child2 %d is complete!!! child2 signal code = %d \n&quot;</span><span class="token punctuation">,</span> wpid2<span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>wstatus2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            should_wait_child2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> wpid2<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 等待失败</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wait child2 failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wpid2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 主进程做其他事情</span>
        <span class="token comment">// .....</span>

        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> wpid1 <span class="token operator">||</span> <span class="token number">0</span> <span class="token operator">==</span> wpid2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意do-while后面需要加;号</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, wait all child complete!!! I will exit \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// pid_t pid1 = fork(), pid2 = fork(), wpid1, wpid2; // 陷阱，不要妄想着在一条语句中fork多个子进程！</span>

    <span class="token comment">// 循环创建多个子进程</span>
    <span class="token class-name">pid_t</span> childs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 不要让元素的默认值为0，防止后续逻辑出问题</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 仅在父进程中执行fork</span>
        childs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 防止子进程继续fork</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> childs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fork失败</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork child failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 下面是用fork的返回值来区分父子进程</span>
    <span class="token comment">// 在子进程1中，childs = {0, -1}</span>
    <span class="token comment">// 在子进程2中，childs = {子进程1的pid，0}</span>
    <span class="token comment">// 在父进程中，childs = {子进程1的pid，子进程2的pid}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> childs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程1的逻辑</span>
        <span class="token function">do_child1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> childs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程2的逻辑</span>
        <span class="token function">do_child2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程的逻辑</span>
        <span class="token function">do_parent</span><span class="token punctuation">(</span>childs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><ol><li><p>当针对指定的子进程回收时，需要注意避免二次回收</p></li> <li><p>为什么上述示例中，父进程的逻辑使用<code>else if (-1 == wpid1)</code>这种特别判断而不是<code>else</code>这种例外判断？因为在<code>else if (should_wait_child1 == 1 &amp;&amp; wpid1 == childs[0])</code>中使用了组合逻辑，意外使得<code>else</code>例外判断的范围变大了，即<code>should_wait_child1 == 0</code>时也被判断到了<code>else</code>中，从而掉入了编程陷阱</p></li></ol></blockquote> <p>==循环回收多个子进程==</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环创建多个子进程</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 防止子进程继续fork</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork child failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 下面是用fork的返回值来区分父进程和子进程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程的逻辑：循环回收多个子进程</span>
        <span class="token class-name">pid_t</span> wpid<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wpid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wpid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 回收成功</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;wait child%d success \n&quot;</span><span class="token punctuation">,</span> wpid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> wpid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程未终止</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;wait child no complete \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 返回为-1时加以判断是不是没有子进程可回收了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ECHILD <span class="token operator">==</span> errno<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;all child is wait complete! \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 这里对应的是信号中断了waitpid</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;waitpid error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am child%d, pid = %d \n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>思考：<code>while</code>循环中的<code>waitpid</code>会不会总是等待同一个子进程从而造成二次回收使得返回值为-1？不会，因为<code>waitpid</code>总是针对<strong>可回收的</strong>子进程</p> <p>经验学习：当我们设计一个可能要在循环中重复使用的 api 时，这个 api 所针对的对象，应该是一个<strong>被定性的</strong>对象，从而避免循环中所针对的对象总是同一个对象</p></blockquote></li> <li><p>==孤儿进程==：父进程先于子进程终止，使得子进程成为孤儿进程，此时<strong>systemd</strong>进程会作为它的父进程，<strong>并负责它的回收</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fork失败</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am child, my parent_id = %d \n&quot;</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程先于子进程终止</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, my id = %d \n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;-- parent going to die --&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>对于孤儿进程，可以直接使用<code>kill -9 &lt;孤儿进程号&gt;</code>命令将其终止，然后由 <strong>systemd</strong> 进程将其回收</p> <p>实际上，只要不是特别占用系统资源的孤儿进程，对于系统都是无害的。毕竟有时候我们出于某种目的也会人为制造一些孤儿进程</p></blockquote></li> <li><p>==僵尸进程==：子进程已终止，父进程未终止，但是父进程并未对子进程进行回收，使得子进程成为僵尸进程，僵尸进程对于系统是有害的</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fork失败</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 子进程先终止，父进程未终止但不干人事（回收子进程）</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am child, my parent_id = %d \n&quot;</span><span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;-- child going to die --&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 父进程</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent, my id = %d \n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>对于僵尸进程，使用<code>kill -9 &lt;僵尸进程号&gt;</code>命令已经无效了，因为它已经终止了</p> <p><strong>清除僵尸进程</strong>：使用<code>kill -9 &lt;僵尸进程的父进程号&gt;</code>命令，使得僵尸进程成为孤儿进程，从而让 <strong>systemd</strong> 进程对其进行回收</p></blockquote></li></ol> <h2 id="进程间通信"><a href="#进程间通信" class="header-anchor">#</a> 进程间通信</h2> <h3 id="常用的方法"><a href="#常用的方法" class="header-anchor">#</a> 常用的方法</h3> <ul><li>管道：最简单</li> <li>信号量：开销小</li> <li>mmap：速度最快，并且可以应用在非亲缘关系</li> <li>本地 socket：稳定性最好</li></ul> <h3 id="管道"><a href="#管道" class="header-anchor">#</a> 管道</h3></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/myblog/Linux/shell编程.html" class="prev">
          shell编程
        </a></span> <!----></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#基础知识" class="sidebar-link reco-side-基础知识" data-v-b57cc07c>基础知识</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#虚拟地址空间" class="sidebar-link reco-side-虚拟地址空间" data-v-b57cc07c>虚拟地址空间</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#mmu" class="sidebar-link reco-side-mmu" data-v-b57cc07c>MMU</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#pcb" class="sidebar-link reco-side-pcb" data-v-b57cc07c>PCB</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#文件描述符" class="sidebar-link reco-side-文件描述符" data-v-b57cc07c>文件描述符</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#文件系统" class="sidebar-link reco-side-文件系统" data-v-b57cc07c>文件系统</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#inode与dentry" class="sidebar-link reco-side-inode与dentry" data-v-b57cc07c>inode与dentry</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#系统调用" class="sidebar-link reco-side-系统调用" data-v-b57cc07c>系统调用</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#库函数" class="sidebar-link reco-side-库函数" data-v-b57cc07c>库函数</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#错误处理" class="sidebar-link reco-side-错误处理" data-v-b57cc07c>错误处理</a></li><li class="level-2" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#文件" class="sidebar-link reco-side-文件" data-v-b57cc07c>文件</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#open" class="sidebar-link reco-side-open" data-v-b57cc07c>open</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#close" class="sidebar-link reco-side-close" data-v-b57cc07c>close</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#read" class="sidebar-link reco-side-read" data-v-b57cc07c>read</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#write" class="sidebar-link reco-side-write" data-v-b57cc07c>write</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#fsync" class="sidebar-link reco-side-fsync" data-v-b57cc07c>fsync</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#lseek" class="sidebar-link reco-side-lseek" data-v-b57cc07c>lseek</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#truncate" class="sidebar-link reco-side-truncate" data-v-b57cc07c>truncate</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#fcntl" class="sidebar-link reco-side-fcntl" data-v-b57cc07c>fcntl</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#stat" class="sidebar-link reco-side-stat" data-v-b57cc07c>stat</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#readlink" class="sidebar-link reco-side-readlink" data-v-b57cc07c>readlink</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#link" class="sidebar-link reco-side-link" data-v-b57cc07c>link</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#unlink" class="sidebar-link reco-side-unlink" data-v-b57cc07c>unlink</a></li><li class="level-2" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#进程控制" class="sidebar-link reco-side-进程控制" data-v-b57cc07c>进程控制</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#进程状态" class="sidebar-link reco-side-进程状态" data-v-b57cc07c>进程状态</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#进程号" class="sidebar-link reco-side-进程号" data-v-b57cc07c>进程号</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#fork" class="sidebar-link reco-side-fork" data-v-b57cc07c>fork</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#exec" class="sidebar-link reco-side-exec" data-v-b57cc07c>exec</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#进程回收" class="sidebar-link reco-side-进程回收" data-v-b57cc07c>进程回收</a></li><li class="level-2" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#进程间通信" class="sidebar-link reco-side-进程间通信" data-v-b57cc07c>进程间通信</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#常用的方法" class="sidebar-link reco-side-常用的方法" data-v-b57cc07c>常用的方法</a></li><li class="level-3" data-v-b57cc07c><a href="/myblog/Linux/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B.html#管道" class="sidebar-link reco-side-管道" data-v-b57cc07c>管道</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/myblog/assets/js/app.cf03cf17.js" defer></script><script src="/myblog/assets/js/7.c0fa18da.js" defer></script><script src="/myblog/assets/js/2.5b1d6a19.js" defer></script><script src="/myblog/assets/js/1.3eb0cb5d.js" defer></script><script src="/myblog/assets/js/31.790d8053.js" defer></script>
  </body>
</html>
